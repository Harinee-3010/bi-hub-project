{% extends 'hub/base.html' %}
{% load static %}

{% block content %}
<!-- --- PAGE HEADER (THIS IS THE FIX) --- -->
<div class="pb-3 border-bottom mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h2 mb-0">Sales Forecast Simulation</h1>
        <h2 class="h5 text-body-secondary mb-0">File: {{ file.file.name|cut:"retail_uploads/" }}</h2>
    </div>
    <div>
        <!-- --- THIS BUTTON IS UPDATED --- -->
        <!-- It now points to 'retail_dashboard' (the file list) -->
        <a href="{% url 'retail_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i>
            Back to Files
        </a>
        <!-- --- END OF UPDATE --- -->
    </div>
</div>
<!-- --- END HEADER --- -->

{% if error %}
    <!-- Show an error if the AI or model failed -->
    <div class="alert alert-danger">
        <strong>Error:</strong> {{ error }}
        <p>This can happen if the file doesn't have a clear date column or enough historical data (at least 24 months is recommended).</p>
    </div>
{% elif forecast_data_for_template %}
    <!-- This is the safe way to pass data -->
    {{ forecast_data_for_template|json_script:"forecast-data" }}

    <!-- Row for Summary Card -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card text-bg-primary">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-graph-up-arrow me-2"></i>Forecast Summary</h5>
                    <!-- The new AI-generated summary will appear here -->
                    <p class="card-text fs-5" id="forecast-summary-text">Loading summary...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row for Chart -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Historical Sales vs. 12-Month Forecast</h5>
                    <div style="height: 450px;">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
{% else %}
    <!-- Loading state (unchanged) -->
    <div class="card text-center">
        <div class="card-body p-5">
            <h5 class="card-title">Running Simulation...</h5>
            <p>This is a complex calculation and may take up to 60 seconds. Please wait.</p>
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
{% endif %}

{% endblock %}


<!-- --- NEW SCRIPT BLOCK (Unchanged) --- -->
{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        const forecastDataElement = document.getElementById('forecast-data');
        if (!forecastDataElement) {
            console.log("No forecast data element found.");
            return;
        }
        
        let data;
        try {
            data = JSON.parse(forecastDataElement.textContent);
        } catch (e) {
            console.error("Failed to parse forecast data:", e);
            return;
        }

        // Update the summary card
        const summaryEl = document.getElementById('forecast-summary-text');
        if (summaryEl && data.summary) {
            // This will now show the new human-like summary
            summaryEl.innerText = data.summary;
        }

        // Find the canvas
        const ctx = document.getElementById('forecastChart');
        if (!ctx) return;
        
        // Set chart text color to match our dark theme
        Chart.defaults.color = '#e0e7ff'; 

        // Combine all labels for the X-axis
        const allLabels = data.historical_labels.concat(data.forecast_labels);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: allLabels,
                datasets: [
                    {
                        label: 'Historical Sales',
                        data: data.historical_values,
                        borderColor: 'rgba(54, 162, 235, 1)', // Blue
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: 'Forecasted Sales',
                        data: new Array(data.historical_values.length).fill(null).concat(data.forecast_values),
                        borderColor: 'rgba(75, 192, 192, 1)', // Green
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: 'Confidence Interval',
                        data: new Array(data.historical_values.length).fill(null).concat(data.upper_ci),
                        fill: '-1', // Fill to the dataset at index - 1 (Forecasted Sales)
                        backgroundColor: 'rgba(255, 99, 132, 0.1)', // Light Red fill
                        borderColor: 'rgba(255, 99, 132, 0.3)',
                        pointRadius: 0,
                    },
                    {
                        // This is a "ghost" dataset just to fill the bottom half
                        label: 'Confidence Interval (Lower)',
                        data: new Array(data.historical_values.length).fill(null).concat(data.lower_ci),
                        fill: false, // No fill
                        borderColor: 'rgba(255, 99, 132, 0.3)',
                        pointRadius: 0,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Sales Value'
                        },
                        beginAtZero: false // Sales might not start at 0
                    }
                }
            }
        });
    });
</script>
{% endblock %}